<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Admin API • Session-first UI</title>
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--card:#0b1220;--outline:rgba(255,255,255,.08);
      --text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--accent2:#06b6d4;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
    .header{padding:12px 20px;background:var(--panel);border-bottom:1px solid var(--outline);font-weight:600}
    .wrap{flex:1;display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;min-height:0}
    .card{background:var(--panel);border:1px solid var(--outline);border-radius:12px;display:flex;flex-direction:column;min-height:0}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--outline);font-size:14px}
    .content{padding:12px 14px;gap:10px;display:flex;flex-direction:column}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--outline);background:#0f172a;color:#e5e7eb;outline:none}
    textarea{resize:none;min-height:52px;max-height:140px}
    button{padding:10px 14px;border:none;border-radius:10px;color:#fff;background:#1e293b;cursor:pointer}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2))}
    button.ghost{background:#1e293b;color:var(--text);border:1px solid var(--outline)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .sessions{flex:1;overflow:auto;padding:8px}
    .sess{width:100%;text-align:left;background:#0f172a;border:1px solid var(--outline);border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer}
    .sess.active{outline:2px solid var(--accent)}
    .sess .id{font-size:12px;font-weight:600;word-break:break-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .sess .meta{font-size:11px;color:var(--muted)}
    .chat{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px;background:var(--card)}
    .msg{max-width:72%;padding:12px 14px;border-radius:14px;line-height:1.45;position:relative;box-shadow:0 4px 10px rgba(0,0,0,.25)}
    .msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#16a34a);color:#fff;border-bottom-right-radius:4px}
    .msg.assistant{align-self:flex-start;background:#172033;border-bottom-left-radius:4px}
    .meta{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--outline);background:var(--panel)}
    .banner{padding:10px 12px;border-radius:10px;font-size:13px}
    .banner.err{background:#3b0d12;color:#ffdada;border:1px solid #5b1a22}
    .banner.ok{background:#0b2714;color:#d7ffe3;border:1px solid #164a2a}
    .muted{color:var(--muted);font-size:12px}
    @media (max-width:960px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="header">Chat Admin API • Session-first</div>

  <div class="wrap">
    <div class="card">
      <h3>Identitas & Sessions</h3>
      <div class="content">
        <div id="stepUser">
          <div class="row">
            <input id="user" placeholder="User [id@nama] — contoh: 123@Budi Santoso" />
          </div>
          <div class="row">
            <input id="token" placeholder="Token (opsional) untuk Authorization: Bearer ..." />
          </div>
          <div class="row">
            <button id="btnOk" class="primary">OK</button>
          </div>
          <div class="muted">Masukkan user dengan format id@nama, lalu tekan OK.</div>
        </div>

        <div id="stepSessions" style="display:none">
          <div class="row">
            <button id="btnLoad" class="ghost">Load Sessions</button>
            <button id="btnNew" class="primary">New Session</button>
          </div>
          <div id="banner" class="banner" style="display:none"></div>
          <div id="sessions" class="sessions"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Chat</h3>
      <div id="chat" class="chat"></div>
      <div class="composer">
        <textarea id="input" placeholder="Ketik pesan…" disabled></textarea>
        <button id="btnSend" class="primary" disabled>Kirim</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "";

    const $ = (id) => document.getElementById(id);
    const userEl = $("user"), tokenEl = $("token"), stepUserEl = $("stepUser");
    const stepSessionsEl = $("stepSessions"), sessionsEl = $("sessions"), chatEl = $("chat");
    const inputEl = $("input"), bannerEl = $("banner");
    const btnOk = $("btnOk"), btnLoad = $("btnLoad"), btnNew = $("btnNew"), btnSend = $("btnSend");

    let selectedSession = localStorage.getItem("chat_selected_session") || null;

    userEl.value = localStorage.getItem("chat_user") || "";
    tokenEl.value = localStorage.getItem("chat_token") || "";

    function savePrefs(){
        localStorage.setItem("chat_user", userEl.value);
        localStorage.setItem("chat_token", tokenEl.value);
        localStorage.setItem("chat_selected_session", selectedSession || "");
    }

    function showBanner(text, kind="ok"){
        if(!text){ bannerEl.style.display="none"; return; }
        bannerEl.className = `banner ${kind==="err" ? "err" : "ok"}`;
        bannerEl.textContent = text;
        bannerEl.style.display = "block";
    }

    function validUser(u){
        return u && u.includes("@") && u.split("@")[0].trim() && u.split("@")[1].trim();
    }

    function headers(json=true){
        const h = {};
        if(json) h["Content-Type"] = "application/json";
        const t = tokenEl.value.trim();
        if(t) h["Authorization"] = `Bearer ${t}`;
        return h;
    }

    async function api(path, payload){
        const init = { headers: headers(!!payload) };
        if(payload){ init.method = "POST"; init.body = JSON.stringify(payload); }
        const res = await fetch(API_BASE + path, init);
        const data = await res.json().catch(() => null);
        if(!res.ok) throw new Error((data && data.error) || `HTTP ${res.status}`);
        return data;
    }

    async function confirmUser(){
        const u = userEl.value.trim();
        if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }
        savePrefs();
        showBanner("");
        await loadSessions();
    }

    async function loadSessions(){
        const u = userEl.value.trim();
        if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }
        sessionsEl.innerHTML = "<div class='meta'>Memuat...</div>";
        try{
            const data = await api(`/api/sessions?user=${encodeURIComponent(u)}`);
            stepUserEl.style.display = "none";
            stepSessionsEl.style.display = "block";
            const list = (data.sessions || []).sort((a,b) => (Date.parse(b.created_at) || 0) - (Date.parse(a.created_at) || 0));
            renderSessions(list);
            showBanner(list.length ? `Ditemukan ${list.length} sesi untuk ${data.name}` : `Belum ada sesi. Klik New Session.`, "ok");
        }catch(e){
            sessionsEl.innerHTML = "";
            showBanner(e.message || "Gagal memuat sesi", "err");
            stepUserEl.style.display = "block";
            stepSessionsEl.style.display = "none";
        }
    }

    function renderSessions(list){
        sessionsEl.innerHTML = !list.length ? "<div class='meta'>Belum ada sesi.</div>" : "";
        list.forEach(s => {
            const btn = document.createElement("button");
            btn.className = "sess" + (selectedSession === s.session_id ? " active" : "");
            btn.dataset.sid = s.session_id;
            btn.innerHTML = `
                <div class="id" title="${s.title}">${s.title}</div>
                <div class="meta">Dibuat: ${s.created_at ? new Date(s.created_at).toLocaleString('id-ID', {dateStyle:'short', timeStyle:'short'}) : "-"}</div>
                <div class="meta">Pesan: ${s.messages_count ?? 0}</div>
            `;
            btn.onclick = () => activateSession(s.session_id, false);
            sessionsEl.appendChild(btn);
        });
    }

    async function activateSession(sessionId, isNewExplicit){
        const u = userEl.value.trim();
        if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }

        selectedSession = sessionId;
        savePrefs();
        document.querySelectorAll(".sess").forEach(x => x.classList.toggle("active", x.dataset.sid === sessionId));

        chatEl.innerHTML = "<div class='meta'>Memuat pesan…</div>";

        try{
            const data = await api(`/api/session/messages?user=${encodeURIComponent(u)}&session_id=${encodeURIComponent(selectedSession)}`);
            const nonSystem = (data.messages || []).filter(m => m && m.role !== "system");
            
            chatEl.innerHTML = "";
            
            if(!nonSystem.length){
                addMsg("assistant", "(Sesi ini kosong)", new Date().toISOString());
            } else {
                nonSystem.forEach(m => addMsg(m.role, m.content || "", m.timestamp));
            }
            
            if (!isNewExplicit) {
                const userName = data.name || u.split('@')[1];
                const welcomeBackMsg = `Selamat datang kembali, ${userName}! Anda bisa melanjutkan percakapan ini.`;
                addMsg("assistant", welcomeBackMsg, new Date().toISOString());
            }

            showBanner(`Session aktif: ${sessionId.substring(0,18)}...`, "ok");
            inputEl.disabled = false;
            btnSend.disabled = false;
            inputEl.focus();
        }catch(e){
            chatEl.innerHTML = "";
            addMsg("assistant", "[error] " + (e.message || "Gagal memuat pesan"), new Date().toISOString());
            showBanner(e.message || "Gagal memuat pesan", "err");
        }
    }
    
    async function newSession(){
        const u = userEl.value.trim();
        if(!validUser(u)) return showBanner("User tidak valid.", "err");

        showBanner("Membuat sesi baru...", "ok");
        chatEl.innerHTML = "<div class='meta'>Mohon tunggu...</div>";
        inputEl.disabled = true;
        btnSend.disabled = true;

        try {
            const data = await api("/api/sessions", { user: u });
            await loadSessions(); 
            await activateSession(data.session_id, true);
        } catch(e) {
            showBanner(e.message || "Gagal membuat sesi baru", "err");
            chatEl.innerHTML = "";
        }
    }

    function addMsg(role, content, timestamp){
        const box = document.createElement("div");
        box.className = `msg ${role}`;
        box.textContent = content;
        
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = timestamp 
            ? new Date(timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) 
            : new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

        box.appendChild(meta);
        chatEl.appendChild(box);
        chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function sendMessage(){
        const u = userEl.value.trim();
        const msg = inputEl.value.trim();
        if(!validUser(u)) return showBanner("Isi user dengan format: id@nama", "err");
        if(!msg) return;

        if (!selectedSession) return showBanner("Tidak ada sesi aktif. Klik 'New Session' dahulu.", "err");
        
        addMsg("user", msg, new Date().toISOString());
        inputEl.value = "";
        
        try{
            const payload = { user: u, message: msg, session_id: selectedSession };
            const res = await api("/api/chat", payload);
            addMsg("assistant", res.answer || "(kosong)", new Date().toISOString());
        }catch(e){
            addMsg("assistant", "[error] " + (e.message || "Gagal mengirim pesan"), new Date().toISOString());
        }
    }

    btnOk.onclick   = confirmUser;
    btnLoad.onclick = loadSessions;
    btnNew.onclick  = newSession;
    btnSend.onclick = sendMessage;
    inputEl.addEventListener("keydown", (e) => {
        if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            sendMessage();
        }
    });
  </script>
</body>
</html>
