<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Admin API â€¢ Session-first UI</title>
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--card:#0b1220;--outline:rgba(255,255,255,.08);
      --text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--accent2:#06b6d4;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
    .header{padding:12px 20px;background:var(--panel);border-bottom:1px solid var(--outline);font-weight:600}
    .wrap{flex:1;display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;min-height:0}
    .card{background:var(--panel);border:1px solid var(--outline);border-radius:12px;display:flex;flex-direction:column;min-height:0}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--outline);font-size:14px}
    .content{padding:12px 14px;gap:10px;display:flex;flex-direction:column}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--outline);background:#0f172a;color:#e5e7eb;outline:none}
    textarea{resize:none;min-height:52px;max-height:140px}
    button{padding:10px 14px;border:none;border-radius:10px;color:#fff;background:#1e293b;cursor:pointer}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2))}
    button.ghost{background:#1e293b;color:var(--text);border:1px solid var(--outline)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .sessions{flex:1;overflow:auto;padding:8px}
    .sess{width:100%;text-align:left;background:#0f172a;border:1px solid var(--outline);border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer}
    .sess.active{outline:2px solid var(--accent)}
    .sess .id{font-size:12px;font-weight:600;word-break:break-all}
    .sess .meta{font-size:11px;color:var(--muted)}
    .summary-panel{display:none;margin:10px 14px 0 14px;background:#0f172a;border:1px dashed var(--outline);border-radius:10px;padding:10px 12px;font-size:13px}
    .chat{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px;background:var(--card)}
    .msg{max-width:72%;padding:12px 14px;border-radius:14px;line-height:1.45;position:relative;box-shadow:0 4px 10px rgba(0,0,0,.25)}
    .msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#16a34a);color:#fff;border-bottom-right-radius:4px}
    .msg.assistant{align-self:flex-start;background:#172033;border-bottom-left-radius:4px}
    .meta{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--outline);background:var(--panel)}
    .banner{padding:10px 12px;border-radius:10px;font-size:13px}
    .banner.err{background:#3b0d12;color:#ffdada;border:1px solid #5b1a22}
    .banner.ok{background:#0b2714;color:#d7ffe3;border:1px solid #164a2a}
    .muted{color:var(--muted);font-size:12px}
    @media (max-width:960px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="header">Chat Admin API â€¢ Session-first</div>

  <div class="wrap">
    <div class="card">
      <h3>Identitas & Sessions</h3>
      <div class="content">
        <div id="stepUser">
          <div class="row">
            <input id="user" placeholder="User [id@nama] â€” contoh: u123@Budi Santoso" />
          </div>
          <div class="row">
            <input id="token" placeholder="Token (opsional) untuk Authorization: Bearer ..." />
          </div>
          <div class="row">
            <button id="btnOk" class="primary">OK</button>
          </div>
          <div class="muted">Masukkan user dengan format id@nama, lalu tekan OK.</div>
        </div>

        <div id="stepSessions" style="display:none">
          <div class="row">
            <button id="btnLoad" class="ghost">Load Sessions</button>
            <button id="btnNew" class="ghost">New Session</button>
          </div>
          <div id="banner" class="banner" style="display:none"></div>
          <div id="sessions" class="sessions"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Chat</h3>
      <div id="summary" class="summary-panel"></div>
      <div id="chat" class="chat"></div>
      <div class="composer">
        <textarea id="input" placeholder="Ketik pesanâ€¦" disabled></textarea>
        <button id="btnSend" class="primary" disabled>Kirim</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Konfigurasi
    // =========================
    const API_BASE = ""; // kosong = origin yang sama.

    // =========================
    // Helper DOM
    // =========================
    const $ = (id) => document.getElementById(id);
    const userEl = $("user");
    const tokenEl = $("token");
    const stepUserEl = $("stepUser");
    const stepSessionsEl = $("stepSessions");
    const sessionsEl = $("sessions");
    const chatEl = $("chat");
    const summaryEl = $("summary");
    const inputEl = $("input");
    const bannerEl = $("banner");
    const btnOk = $("btnOk");
    const btnLoad = $("btnLoad");
    const btnNew = $("btnNew");
    const btnSend = $("btnSend");

    let selectedSession = localStorage.getItem("chat_selected_session") || "";
    let messagesInView = [];
    let currentSessions = []; // cache hasil /api/sessions

    // restore ringan
    userEl.value = localStorage.getItem("chat_user") || "";
    tokenEl.value = localStorage.getItem("chat_token") || "";

    // ---------- util ----------
    function savePrefs(){
      localStorage.setItem("chat_user", userEl.value);
      localStorage.setItem("chat_token", tokenEl.value);
      localStorage.setItem("chat_selected_session", selectedSession || "");
    }

    function showBanner(text, kind="ok"){
      if(!text){ bannerEl.style.display="none"; return; }
      bannerEl.className = "banner " + (kind==="err" ? "err" : "ok");
      bannerEl.textContent = text;
      bannerEl.style.display = "block";
    }

    function showSummary(text){
      if(text && text.trim()){
        summaryEl.textContent = text;
        summaryEl.style.display = "block";
      }else{
        summaryEl.textContent = "";
        summaryEl.style.display = "none";
      }
    }

    function validUser(u){
      return u && u.includes("@") && u.split("@")[0].trim() && u.split("@")[1].trim();
    }

    function headers(json=true){
      const h = {};
      if(json) h["Content-Type"] = "application/json";
      const t = tokenEl.value.trim();
      if(t) h["Authorization"] = `Bearer ${t}`;
      return h;
    }

    async function api(path, payload){
      const init = { headers: headers(!!payload) };
      if(payload){ init.method = "POST"; init.body = JSON.stringify(payload); }
      const res = await fetch(API_BASE + path, init);
      let data = null;
      try{ data = await res.json(); }catch(_){}
      if(!res.ok){
        throw new Error((data && data.error) || `HTTP ${res.status}`);
      }
      return data;
    }

    // =========================
    // STEP 1: OK (tidak auto-buka sesi)
    // =========================
    async function confirmUser(){
      const u = userEl.value.trim();
      if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }
      savePrefs();
      showBanner("");
      await loadSessions(); // hanya muat daftar
      stepUserEl.style.display = "none";
      stepSessionsEl.style.display = "block";
      inputEl.disabled = true;
      btnSend.disabled = true;
      showSummary("");
      chatEl.innerHTML = "<div class='meta'>Pilih salah satu sesi di kiri, atau klik New Session.</div>";
    }

    // =========================
    // Sessions
    // =========================
    async function loadSessions(){
      const u = userEl.value.trim();
      if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }
      sessionsEl.innerHTML = "<div class='meta'>Memuat...</div>";
      try{
        const data = await api(`/api/sessions?user=${encodeURIComponent(u)}`);
        const list = (data.sessions || []).slice().sort((a,b)=>{
          const ta = a.created_at ? Date.parse(a.created_at) : 0;
          const tb = b.created_at ? Date.parse(b.created_at) : 0;
          return tb - ta;
        });
        currentSessions = list;
        renderSessions(list);
        if(list.length){
          showBanner(`Ditemukan ${list.length} sesi untuk ${data.name}`, "ok");
        }else{
          showBanner(`Belum ada sesi untuk ${data.name}. Klik New Session untuk membuat.`, "ok");
        }
      }catch(e){
        sessionsEl.innerHTML = "";
        showBanner(e.message || "Gagal memuat sesi", "err");
      }
    }

    function renderSessions(list){
      sessionsEl.innerHTML = "";
      if(!list.length){
        sessionsEl.innerHTML = "<div class='meta'>Belum ada sesi.</div>";
        return;
      }
      list.forEach(s => {
        const btn = document.createElement("button");
        btn.className = "sess" + (selectedSession === s.session_id ? " active" : "");
        btn.dataset.sid = s.session_id;
        
        // --- ðŸ”¥ INI PERBAIKANNYA ðŸ”¥ ---
        // Menampilkan s.title (judul) bukan s.session_id
        btn.innerHTML = `
          <div class="id">${s.title}</div>
          <div class="meta">Dibuat: ${s.created_at ? new Date(s.created_at).toLocaleString() : "-"}</div>
          <div class="meta">Pesan: ${s.messages_count ?? 0}</div>
        `;
        
        // klik sesi lama â†’ isNew = false
        btn.onclick = () => activateSession(s.session_id, false);
        sessionsEl.appendChild(btn);
      });
    }

    async function activateSession(sessionId, isNewExplicit){
      const u = userEl.value.trim();
      if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }

      // highlight
      selectedSession = sessionId;
      savePrefs();
      document.querySelectorAll(".sess").forEach(x => {
        if(x.dataset.sid === sessionId) x.classList.add("active"); else x.classList.remove("active");
      });

      // reset
      messagesInView = [];
      chatEl.innerHTML = "<div class='meta'>Memuat pesanâ€¦</div>";
      showSummary(""); // sembunyikan dulu

      try{
        // Ambil riwayat pesan (bukan summary)
        const data = await api(`/api/session/messages?user=${encodeURIComponent(u)}&session_id=${encodeURIComponent(selectedSession)}`);
        const allMsgs = (data.messages || []);
        const nonSystem = allMsgs.filter(m => !!m && m.role !== "system");

        // Deteksi otomatis sesi baru: hanya 1 bubble assistant (sapaan)
        const justGreeting = (nonSystem.length === 1 && nonSystem[0].role === "assistant");
        const isNew = isNewExplicit || justGreeting;

        chatEl.innerHTML = "";

        if(isNew){
          // Sesi baru â†’ tampilkan pesan (sapaan) saja
          if(!nonSystem.length){
            addMsg("assistant", "(Belum ada pesan)");
          }else{
            nonSystem.forEach(m => addMsg(m.role === "user" ? "user" : "assistant", m.content || ""));
          }
        }else{
          // Sesi lama â†’ tampilkan ringkasan di panel, lalu history
          try{
            const sum = await api(`/api/session/summary?user=${encodeURIComponent(u)}&session_id=${encodeURIComponent(selectedSession)}`);
            if(!sum.skip && (sum.summary || "").trim()){
              showSummary("Ringkasan sesi ini: " + sum.summary);
            }else{
              showSummary("");
            }
          }catch(e){
            showSummary("[gagal mengambil ringkasan]");
          }
          if(!nonSystem.length){
            addMsg("assistant", "(Belum ada pesan)");
          }else{
            nonSystem.forEach(m => addMsg(m.role === "user" ? "user" : "assistant", m.content || ""));
          }
        }

        showBanner(`Session aktif: ${selectedSession}`, "ok");
        inputEl.disabled = false;
        btnSend.disabled = false;
        inputEl.focus();
      }catch(e){
        chatEl.innerHTML = "";
        addMsg("assistant", "[error] " + (e.message || "Gagal memuat pesan"));
        showBanner(e.message || "Gagal memuat pesan", "err");
      }
    }

    async function newSession(){
      const u = userEl.value.trim();
      if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }
      try{
        const data = await api("/api/sessions", { user: u });
        selectedSession = data.session_id;
        savePrefs();
        await loadSessions();                       // refresh daftar
        await activateSession(selectedSession, true); // isNew = true â†’ sapaan saja
        showBanner("Sesi baru dibuat. Session aktif: " + selectedSession, "ok");
      }catch(e){
        showBanner(e.message || "Gagal membuat sesi baru", "err");
      }
    }

    // =========================
    // Chat
    // =========================
    function addMsg(role, content){
      const box = document.createElement("div");
      box.className = `msg ${role}`;
      box.textContent = content;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = new Date().toLocaleTimeString();
      box.appendChild(meta);
      chatEl.appendChild(box);
      chatEl.scrollTop = chatEl.scrollHeight; // auto-scroll ke bawah untuk lihat pesan terbaru
      messagesInView.push({role, content});
    }

    async function sendMessage(){
      const u = userEl.value.trim();
      const msg = inputEl.value;
      if(!validUser(u)){ showBanner("Isi user dengan format: id@nama", "err"); return; }
      if(!selectedSession){ showBanner("Pilih atau buat session terlebih dahulu.", "err"); return; }
      if(!msg.trim()) return;

      addMsg("user", msg);
      inputEl.value = "";
      try{
        const res = await api("/api/chat", { user: u, session_id: selectedSession, message: msg });
        addMsg("assistant", res.answer || "(kosong)");
      }catch(e){
        addMsg("assistant", "[error] " + (e.message || "Gagal mengirim pesan"));
      }
    }

    // =========================
    // Events
    // =========================
    btnOk.onclick   = confirmUser;
    btnLoad.onclick = () => loadSessions(); // refresh manual
    btnNew.onclick  = newSession;
    btnSend.onclick = sendMessage;
    inputEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
